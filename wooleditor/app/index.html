<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Wool editor</title>

	<!-- libraries -->
	<!-- Insert this line above jquery script imports.
	See: https://stackoverflow.com/questions/52381131/jstree-is-not-a-function-using-jstree-in-electron-js  -->
	<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

	<script type="text/javascript" src="js/libs/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="js/libs/jquery.mousewheel.min.js"></script>
	<script type="text/javascript" src="js/libs/transit.js"></script>
	<script type="text/javascript" src="js/libs/knockout-3.3.0.js"></script>
	<script type="text/javascript" src="js/libs/knockout.ace.js"></script>
	<script type="text/javascript" src="js/libs/ace.js"></script>
	<script type="text/javascript" src="js/libs/typo.js"></script>
	<script type="text/javascript" src="js/libs/spellcheck_ace.js"></script>
	<script type="text/javascript" src="js/libs/theme-yarn.js"></script>
	<script type="text/javascript" src="js/libs/mode-yarn.js"></script>

	<script type="text/javascript" src="../../html5/lib/i18n/gettext.js"></script>
	<script type="text/javascript" src="../../html5/lib/i18n/i18n.js"></script>

	<script type="text/javascript" src="../../node_modules/split.js/dist/split.min.js"></script>
	<script type="text/javascript" src="../../node_modules/jstree/dist/jstree.min.js"></script>
	<link rel="stylesheet" href="../../node_modules/jstree/dist/themes/default/style.min.css" />

	<!-- various models / classes -->
	<script type="text/javascript" src="js/classes/filesystem.js"></script>
	<script type="text/javascript" src="js/classes/app.js"></script>
	<script type="text/javascript" src="js/classes/data.js"></script>
	<script type="text/javascript" src="js/classes/utils.js"></script>
	<script type="text/javascript" src="js/classes/node.js"></script>

	<script type="text/javascript" src="../../html5/woolserver-js/woolserver-js-api.js"></script>
	<script type="text/javascript" src="../../html5/woolserver-js/woolserver-js.js"></script>

	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/style.css">
</head>
<body>

	<div id='filepanel' class="split">
		<div id="filepanelheader">
			<!-- nwjs style: input type="file" onchange='selectBaseDir(this);' nwdirectory /> -->
			<button onclick='sendSelectBaseDir();'>Select Wool directory</button>
		</div>
		<div id="fileroot"></div>
		<div id="filetree"></div>
	</div>
	<div id='editpanel' class="split">
		<!-- Fancy Background -->
		<div id="app-bg">&nbsp;</div>

		<!-- Entry Point / Container -->
		<div id="app">

			<!-- search form -->
			<div class="app-search">
				Search: 
				<input type="text" class="search-field"/>
				<div class="search-speaker search-item">
					<input type="checkbox" id="search-speaker" />
					<label for="search-speaker">Speaker</label>
				</div>
				<div class="search-title search-item">
					<input type="checkbox" checked="checked" id="search-title" />
					<label for="search-title">Title</label>
				</div>
				<div class="search-body search-item">
					<input type="checkbox" id="search-body" />
					<label for="search-body">Body</label>
				</div>
				<div class="search-tags search-item">
					<input type="checkbox" id="search-tags" />
					<label for="search-tags">Tags</label>
				</div>
			</div>

			<!-- zoom controls -->
			<!--
			<div class="app-zoom">
				<span data-bind="click: function() { app.zoom(4); }"></span>
				<span data-bind="click: function() { app.zoom(3); }"></span>
				<span data-bind="click: function() { app.zoom(2); }"></span>
				<span data-bind="click: function() { app.zoom(1); }"></span>
			</div>
			-->

			<div class="app-sort">
				<span data-bind="click: app.arrangeX" title='Arrange selected nodes'></span>
				<span data-bind="click: app.arrangeY" title='Arrange selected nodes'></span>
				<span data-bind="click: app.center" title='Center diagram'></span>
				<!-- <span data-bind="click: app.arrangeSpiral"></span> -->
				<!-- <span data-bind="click: app.sortAlphabetical"></span> -->
			</div>

			<!-- navigation / menu -->
			<div class="app-menu">
				<div class="menu">
					<span class="title" data-bind="click:app.runDialogue">Run</span>
					<div class="dropdown">
						<span class="item" data-bind="click: app.runDialogue">(Re)start</span>
						<span class="item" data-bind="click: app.contDialogue">Continue</span>
					</div>
				</div>
				<div class="menu">
					<span class="title" data-bind="click:app.newNode">+ Node</span>
				</div>

				<!--<div class="menu">
					<span class="title">Buffer</span>
					<div class="dropdown">
						<a class="item" download="file.wool" href='#' onclick="data.saveToBuffer();">Save</a>
						<span class="item" data-bind="click: data.loadFromBuffer">Reload</span>
					</div>
				</div>-->
				<div class="menu">
					<span class="title">File</span>
					<div class="dropdown">
						<span class="item" data-bind="click: data.tryClearData">New project...</span>
						<span class="item" data-bind="click: data.tryOpenFile">Open...</span>
						<!--<span class="item" data-bind="click: data.tryOpenFolder">Open Folder...</span>-->
						<span class="item" data-bind="click: data.tryAppend">Append...</span>
						<a class="item" download="file.wool" href='#' onclick="return data.saveFileDialog(this,FILETYPE.WOOL,data.getSaveData(FILETYPE.WOOL));">Save...</a>
						<a class="item" download="file.csv" href='#' onclick="data.saveFileDialog(this,FILETYPE.JSON,data.getSaveData(FILETYPE.JSON));">Export Poeditor Terms</a>
						<span class="item" data-bind="click: data.tryOpenLang">Load Translation</span>
						<!-- ko if:data.editingPath() != null -->
						<!--
						<span class="item" data-bind="click: data.trySaveCurrent">Save</span>
						-->
						<!-- /ko -->
						<!--
						<span class="item" data-bind="click: function() { data.trySave(FILETYPE.JSON); }">Save As Json...</span>
						<span class="item" data-bind="click: function() { data.trySave(FILETYPE.YARNTEXT); }">Save As Yarn...</span>
						<span class="item" data-bind="click: function() { data.trySave(FILETYPE.TWEE); }">Save As Twee...</span>
						<span class="item" data-bind="click: function() { data.trySave(FILETYPE.TWEE2); }">Save As Twee2...</span>
						<span class="item" data-bind="click: function() { data.trySave(FILETYPE.XML); }">Save As Xml...</span>
						-->
						<!--<span class="item" data-bind="click: app.quit">Close</span>-->
					</div>
				</div>
			</div>

			<!-- arrow bg canvas for linked nodes -->
			<canvas class="arrows">

			</canvas>

			<!-- foreach loop  of the nodes -->
			<div class="nodes">
				<div class="nodes-holder" data-bind="foreach: { data: app.nodes, as: 'node' }">
					<div class="node" data-bind="nodeBind: true, css: { inactive: !node.active()}" >
						<div class="node-warning" data-bind="text: 
						(node.hasErrors() ? '&#x26a0;' : '')"></div>
						<div class="title" data-bind="text: 
						node.speaker()
						+':&nbsp;'
						+node.title(),
						style: {background:
						node.colorID() == 1 ? '#6EA5E0' :
						node.colorID() == 2 ? '#9EDE74' :
						node.colorID() == 3 ? '#FFE374' :
						node.colorID() == 4 ? '#F7A666' :
						node.colorID() == 5 ? '#C47862' :
						node.colorID() == 6 ? '#97E1E9' :
						'#eee'}"></div>
						<div class="body" data-bind="html: node.clippedBody"></div>
						<div class="tags" data-bind="html: node.clippedTags"></div>
						<div class="icon colorDown" data-bind="click: node.cycleColorDown"></div>
						<div class="icon colorUp" data-bind="click: node.cycleColorUp"></div>
						<!--<div class="icon edit" data-bind="click: function() { app.editNode(node); }"></div>-->
						<div class="icon delete" data-bind="click: node.tryRemove"></div>
						<!--<div class="resize" data-bind="click:node.toggleExpand"></div>-->
					</div>
				</div>
			</div>

			<!-- ko if:app.editing() != null -->
			<div class="node-editor" data-bind="mousedown:app.saveNode">

				<div class="form" data-bind="preventBubble: 'click', preventBubble: 'mousedown'">
					<!--<button onclick='app.editing().compile();'>Compile</button>-->
					<div id="node-errors" class="node-errors"></div>
					Speaker:
					<input type="text" data-bind="value: app.editing().speaker">
					Title:
					<input type="text" class="title" data-bind="value: app.editing().title">
					Tags:
					<input type="text" data-bind="value: app.editing().tags">
					<div class="editor-container">
						<div class="editor" id="editor"
							data-bind="
							ace: app.editing().body, 
							aceOptions: { mode: 'yarn', theme: 'yarn', showPrintMargin: false }">
						</div> 
					</div>
					<!--<div class="icon close" data-bind="click:app.saveNode"></div>-->
					<div class="editor-footer">
						Length: <span class="character-count">0</span>
						&nbsp;
						Lines: <span class="line-count">0</span>
						&nbsp;&nbsp;|&nbsp;&nbsp;
						Line: <span class="line-index">0</span>
						&nbsp;
						Col: <span class="column-index">0</span>
					</div>
				</div>
			</div>
			<!-- /ko -->

			<!-- ko if:app.deleting() != null -->
			<div class="node-delete" data-bind="click: function() { app.deleting(null); }">

				<div class="form" data-bind="preventBubble: 'click'">
					<!-- ko if: (app.deleting().selected && (app.getSelectedNodes().length > 1)) -->
					<div>Remove all selected</div>
					<!-- /ko -->
					<!-- ko ifnot: (app.deleting().selected) -->
					<div>Remove <span data-bind="text: app.deleting().title"></span>?</div>
					<!-- /ko -->
					<!-- ko if: (app.deleting().selected && (app.getSelectedNodes().length == 1)) -->
					<div>Remove <span data-bind="text: app.deleting().title"></span>?</div>
					<!-- /ko -->
					<div class="icon close" data-bind="click:app.deleting().remove;"></div>
				</div>

			</div>
			<!-- /ko -->

			<!-- app info -->
			<div class="app-info">
				<span class="app-title" data-bind="text:app.name"></span>
				<span class="app-version" data-bind="text:app.version"></span>
				<span class="app-filename" data-bind="text:app.filename"></span>
			</div>


			<!-- marquee -->
			<div id="marquee"></div>
		</div>

		<!-- Hidden fields, file dialogs, and elements -->
		<div class="hidden">
			<input type="file" id="open-file" accept=".wool"/>
			<input type="file" id="open-lang" accept=".po,.json"/>
			<input type="file" id="open-folder" webkitdirectory directory/>
			<input type="file" id="save-file" nwsaveas="filename.txt" />
		</div>

		<div id="woolclient-popup" class="woolclient-popup"
		onclick="this.style.display='none';">
			<div class="closebutton" onclick="this.parentNode.style.display='none';">X</div>
			<iframe id="woolclient-popup-iframe"></iframe>
		</div>

		<!-- templates container (they get loaded into this) -->
		<div class="templates">
		</div>

		<!-- start it all up! -->
		<script type="text/javascript">
			window.addEventListener('message', evt => {
				if (evt.data.type === 'dirs-selected') {
					//console.log("Dir selected: "+evt.data.data);
					localStorage.setItem(App.LOCALSTORAGEPREFIX+"root",
						evt.data.data);
					updateDirTree();
				}
			})
			var jsTreeInited=false;
			function updateDirTree() {
				var root = localStorage.getItem(App.LOCALSTORAGEPREFIX+"root");
				if (!root) {
					$("#filetree").html("Please select Wool directory.");
					return;
				}
				$("#fileroot").html(root);
				app.fs.readdirtree(root,function(err,res) {
					if (err) return;
					// convert ["FILE"/"DIR",name,fullpath] to
					// [id:fullpath,text:name,parent,icon]
					var jstdata = [];
					for (var i=0; i<res.length; i++) {
						var item = res[i];
						var basedir = item[2].substring(0,
							item[2].length - item[1].length - 1);
						if (basedir.length == 0) basedir = "#";
						jstdata.push({
							id: item[2],
							text: item[1],
							parent: basedir,
							icon: item[0]=="DIR" ? "jstreedir":"jstreefile",
						});
					}
					if (jsTreeInited) {
						$('#filetree').jstree(true).settings.core.data=jstdata;
						$('#filetree').jstree(true).refresh();
					} else {
						$("#filetree").jstree({
							"core": { "data": jstdata },
							"types" : {
								"default" : {
									"icon" : "glyphicon glyphicon-flash"
								},
								"demo" : {
									"icon" : "glyphicon glyphicon-ok"
								}
							},
							"plugins" : [ "types" ]
						}).on("ready.jstree", function(e,data) {
						//$("#filetree").jstree(true).set_type("/file1","demo");
						//alert($("#filetree").jstree(true).get_type("/file1"));
							$("#filetree").on("select_node.jstree",
							function(e,data) {
								var item = data.node;
								if (data.node.icon == "jstreefile") {
									var filename = data.node.id;
									if (filename.toLowerCase().indexOf(".wool")
									> -1) {
										loadWoolFile(filename);
									}
								}
							});
						});
						jsTreeInited=true;
					}
				});
			}
			function loadWoolFile(filename) {
				data.openFile(null, filename,[ {files: [filename]} ]);
			}
			function sendSelectBaseDir(elem) {
				window.postMessage({type: 'select-dirs'})
			}

			function selectBaseDir(elem) {
				alert(elem.value);
				//localStorage.getItem(App.LOCALSTORAGEPREFIX+"root");
			}

			var filePath = localStorage.getItem(App.LOCALSTORAGEPREFIX+"path");
			var woolRoot = localStorage.getItem(App.LOCALSTORAGEPREFIX+"root");
			if (!filePath) filePath = "unnamed";
			var app = new App("Wool Editor", "1.3",filePath);
			app.run();
			if (app.isNwjs) {
				Split(["#filepanel","#editpanel"],{
					minSize: [0,1070],
					sizes: [15,85],
					snapOffset: 0,
					onDrag: app.updateArrows,
				});
				if (!woolRoot) {
					$("#filetree").html("Please select Wool directory.");
				} else {
					updateDirTree();
				}
			} else {
				$("#filepanel").hide();
				$("#editpanel").css("width","100%");
			}
		</script>
	</div>

</body>
</html>
